---
import { Icon } from "astro-icon/components";
import { getRelativeLocaleUrl } from "astro:i18n";
import { languageList } from "@/i18n/ui";
import { useTranslations } from "@/i18n/utils";

const getPathWithoutLocale = (path: string): string => {
  const segments = path.split("/").filter(Boolean);
  return segments.slice(1).join("/") || "/";
};
const currentPathWithoutLocale = getPathWithoutLocale(Astro.url.pathname);

const currentLang = Astro.currentLocale || "es";
const translateLabels = useTranslations(
  currentLang as keyof typeof languageList,
);

const name = translateLabels("name");
const icon = translateLabels("icon");
const label = translateLabels("label");
---

<div class="relative group">
  <button
    id="language-button"
    class="flex items-center gap-2 px-4 py-2 rounded-lg border border-dark/10 dark:border-light/10 hover:border-accent focus:border-accent transition-all duration-300"
    aria-expanded="false"
    aria-haspopup="true"
    aria-label={currentLang}
  >
    <Icon name={icon} class="w-5 h-5" />
    <span class="text-sm font-medium">
      {name}
    </span>
    <Icon
      name="mdi:chevron-down"
      class="w-4 h-4 transition-transform duration-300 group-hover:rotate-180"
    />
  </button>

  <div
    id="language-dropdown"
    class="absolute right-0 mt-2 w-48 rounded-lg border border-dark/10 dark:border-light/10 bg-light dark:bg-dark shadow-lg opacity-0 invisible translate-y-2 transition-all duration-300 z-50"
    role="menu"
  >
    <div class="py-2">
      {
        Object.entries(languageList).map(([langCode, langName]) => (
          <button
            class={`w-full flex items-center gap-3 px-4 py-2 text-sm transition-colors hover:bg-accent/10
            ${currentLang === langCode ? "text-accent font-medium" : ""}`}
            data-lang={langCode}
            role="menuitem"
            aria-label={langName}
            data-url={getRelativeLocaleUrl(langCode as any, currentPathWithoutLocale)}
          >
            <Icon name={icon} class="w-5 h-5" />
            {langName}
            {currentLang === langCode && (
              <Icon name="mdi:check" class="w-4 h-4 ml-auto" />
            )}
          </button>
        ))
      }
    </div>
  </div>
</div>

<script>
  const button = document.getElementById("language-button");
  const dropdown = document.getElementById("language-dropdown");
  const languageButtons = document.querySelectorAll("[data-lang]");

  button?.addEventListener("click", () => {
    const isExpanded = button.getAttribute("aria-expanded") === "true";
    button.setAttribute("aria-expanded", (!isExpanded).toString());

    if (isExpanded) {
      dropdown?.classList.add("opacity-0", "invisible", "translate-y-2");
    } else {
      dropdown?.classList.remove("opacity-0", "invisible", "translate-y-2");
    }
  });

  document.addEventListener("click", (e) => {
    if (
      !button?.contains(e.target as Node) &&
      !dropdown?.contains(e.target as Node)
    ) {
      button?.setAttribute("aria-expanded", "false");
      dropdown?.classList.add("opacity-0", "invisible", "translate-y-2");
    }
  });

  languageButtons.forEach((langButton) => {
    langButton.addEventListener("click", (e) => {
      const url = (e.currentTarget as HTMLElement).dataset.url;
      if (url) {
        window.location.href = url;
      }
    });
  });
</script>
